#!/usr/local/bin/expect

set HN [exec hostname]
set VAP [exec caget -t "$HN:SYS:VAP"]
set VAN [exec caget -t "$HN:SYS:VAN"]

puts "VAP $VAP VAN $VAN"

#       target = xx * mx/dx + cx
set A_RES { 
	{3.3 2.0 1000 0} 
	{12 11.0 1000 0} 
	{3.3 2.0 1000 0} 
	{3.3 2.0 1000 0}
	{1.8 2.0 1000 0} 
	{1.8 1.0 1000 0} 
	{1.8 2.0 1000 0} 
	{0.0 0.0 1000 0}
}
set B_RES { 
	{2.5 2.0 1000 0} 
	{12 11.0 1000 0} 
	{3.3 2.0 1000 0} 
	{1.8 1.0 1000 0}
	{VAN 6.6 1000 -18.48} 
 	{VAN 6.6 1000 -18.48} 
	{2.5 2.0 1000 0}
	{0.0 0.0 1000 0}
}
set C_RES { 
	{5.0 4.0 1000 0}   
	{5.0 4.0 1000 0} 
	{3.3 2.0 1000 0} 
	{VAP 11.0 1000 0} 
	{VAP 11.0 1000 0}
	{5.0 4.0 1000 0}   
	{5.0 4.0 1000 0} 
	{0.0 0.0 1000 0}
}
set D_RES { 
	{2.5 2.0 1000 0} 
	{1.0 1.0 1000 0} 
	{2.5 2.0 1000 0} 
	{1.5 1.0 1000 0} 
	{1.5 1.0 1000 0}
	{1.0 1.0 1000 0} 
	{0.0 0.0 1000 0} 
	{0.0 0.0 1000 0}
}

proc test_point {label reading formula} {
	global VAN 
	global VAP
	lassign $formula target mx dx cx
	if { $target == "VAP" } { set target $VAP }
	if { $target == "VAN" } { set target $VAN }

	set actual [expr $reading*$mx/$dx +$cx]
	set delta [expr $target - $actual]
	if {$target != 0} {
		set derr [expr abs($delta / $target)]
		if {[expr $derr < 0.1]} {
			set pass "PASS"
		} else {
			set pass "FAIL"
		}
		puts [format "$label target=%6.2f actual=%6.2f pass:$pass" \
			$target $actual]
	}
}

# processing starts here ..
while {[gets stdin line] >= 0 && [string length $line] > 1} {
	set fields [regexp -all -inline {\S+} $line]
	set MX [lindex $fields 1]
	test_point "$MX:MA" [lindex $fields 5] [lindex $A_RES $MX]
	test_point "$MX:MB" [lindex $fields 6] [lindex $B_RES $MX]
	test_point "$MX:MC" [lindex $fields 7] [lindex $C_RES $MX]
	test_point "$MX:MD" [lindex $fields 8] [lindex $D_RES $MX]
}
