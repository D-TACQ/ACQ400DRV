#!/bin/sh
# if there's a previous hanging instance, kill it and drop out
# client can retry at an appropriate moment to restart..

SITE=$1
PID=/var/run/acq400_stream.$SITE.pid

source /etc/sysconfig/acq400.conf

if [ -e $PID ]; then
	logger -t acq400_streamd kill $PID $(cat $PID)
	kill -9 $(cat $PID)
	rm $PID
else	
	if [ -e /etc/sysconfig/acq400_streamd.conf ]; then
		source /etc/sysconfig/acq400_streamd.conf
	fi
	if [ -e /etc/sysconfig/acq400_streamd.$SITE.conf ]; then
		source /etc/sysconfig/acq400_streamd.$SITE.conf
	fi
	if [ -x /etc/sysconfig/acq400_streamd.$SITE.init ]; then
		(/etc/sysconfig/acq400_streamd.$SITE.init) 2>&1 >/dev/null
	fi
	SITE_KNOBS=/etc/acq400/$SITE
	if [ -e $SITE_KNOBS ]; then
		if [ -e $SITE_KNOBS/SAMPLE_SIZE ]; then
			SAMPLE_SIZE="-w $(cat $SITE_KNOBS/SAMPLE_SIZE)"
		fi
		if [ -e $SITE_KNOBS/OVERSAMPLING ]; then
			OVERSAMPLING="-O $(cat $SITE_KNOBS/OVERSAMPLING)"
		fi
		SITE_ARGS=$(eval echo \$SITE${SITE}_ARGS)
	fi
	acq400_stream $SAMPLE_SIZE $OVERSAMPLING $1 &
	echo $! >$PID
	wait
	rm $PID
fi



