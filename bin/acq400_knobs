#!/bin/sh

SITE=${1:-0}
KDIR=${2:-/dev/acq400.$SITE.knobs}

SDIR=/etc/acq400/$SITE

do_site_knob() {
	K=$1; shift; V="$*"

	if [ -x $SDIR/$K ]; then
		$SDIR/$K $V
	elif [ "$V" != "$K" ]; then
		echo $V > $SDIR/$K
	else
		if [ "x$K" = "x/help" ]; then
			ls -1 $SDIR/
		elif [ -e $SDIR/$K ]; then
			cat $SDIR/$K
		else
			echo FILE $SDIR/$K not found
		fi
	fi
}

do_driver_knob() {
	K=$1;  V=$1
	if [ "x$K" = "xhelp" ]; then
		ls -1 $KDIR/
	elif [ -e $KDIR/$K ]; then
		# check no '='
		if [ "$V" != "$K" ]; then
			echo $V > $KDIR/$K
		else
			cat $KDIR/$K
		fi
	else
		echo ERROR knob $KDIR/$K not found
	fi
}

if [ -d $KDIR ]; then
	EOF=NO
	while [ "$EOF" = "NO"  ]; do
		echo -n "acq400.$SITE> "
		read CMD VALUE V2 V3 V4 V5
		if [ $? -eq 0 ]; then
			KNOB=${CMD%%=*}
			if [ "x$VALUE" = "x" ]; then
				VALUE=${CMD##*=}
			fi
			if [ "x${KNOB:0:1}" = "x/" ]; then
				echo do_site_knob $KNOB $VALUE $V2 $V3 $V4 $V5
				do_site_knob $KNOB $VALUE $V2 $V3 $V4 $V5
			else
				do_driver_knob $KNOB $VALUE
			fi
		else
			EOF=YES
		fi
	done
else
	/usr/bin/logger -t acq400_knobs ERROR $KDIR not found
	sleep 100
	exit 1
fi
