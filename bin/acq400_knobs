#!/bin/sh

SITE=${1:-0}

KDIR=/dev/acq400.$SITE.knobs
SDIR=/etc/acq400/$SITE

do_site_knob() {
	K=$1 V=$2

	if [ "$V" != "$K" ]; then
		echo $V > $SDIR/$K
	else
		if [ "x$K" = "x/help" ]; then
			ls -1 $SDIR/
		elif [ -e $SDIR/$K ]; then
			cat $SDIR/$K
		else
			echo FILE $SDIR/$K not found
		fi
	fi
}

do_driver_knob() {
	K=$1; V=$2
	if [ "x$K" = "xhelp" ]; then
		ls -1 $KDIR/
	elif [ -e $KDIR/$K ]; then
		# check no '='
		if [ "$V" != "$K" ]; then
			echo $V > $KDIR/$K
		else
			cat $KDIR/$K
		fi
	else
		echo ERROR knob $KDIR/$K not found
	fi
}

if [ -d $KDIR ]; then
	EOF=NO
	while [ "$EOF" = "NO"  ]; do
		read CMD
		if [ $? -eq 0 ]; then
			KNOB=${CMD%%=*}
			VALUE=${CMD##*=}
			if [ "x${KNOB:0:1}" = "x/" ]; then
				do_site_knob $KNOB $VALUE
			else
				do_driver_knob $KNOB $VALUE
			fi
		else
			EOF=YES
		fi
	done
else
	/usr/bin/logger -t acq400_knobs ERROR $KDIR not found
	sleep 100
	exit 1
fi
