#!/bin/sh

SITE=${1:-0}
SDIR=${2:-/etc/acq400/$SITE}
STATUS=0
USE_PROMPT=0

if [ -e /etc/sysconfig/acq400_knobs.cfg ]; then
	# possible override USE_PROMPT
	source /etc/sysconfig/acq400_knobs.cfg
fi

do_wildcard_query() {
	(cd $SDIR; 
		for file in $* 
		do
			if [ ! -x $file ]; then
				echo $file $(cat $file)
			fi
		done
	)
}
do_site_knob() {
	K=$1; shift; V="$*"

	if [ -x $SDIR/$K ]; then
		$SDIR/$K $V
		STATUS=$?
	elif [ "$V" != "$K" ]; then
		echo $V > $SDIR/$K
		STATUS=$?
	else
		if [ "x$K" = "xhelp" ]; then
			ls -1 $SDIR/
		elif [ -e $SDIR/$K ]; then
			cat $SDIR/$K
			STATUS=$?
		else
			echo FILE $SDIR/$K not found
			STATUS=1
		fi
	fi
}

if [ -d $SDIR ]; then
	EOF=NO
	while [ "$EOF" = "NO"  ]; do
		if [ $USE_PROMPT -ne 0 ]; then
			echo -n "acq400.$SITE:$STATUS> "
		fi
		STATUS=0
		read CMD VALUE V2 V3 V4 V5
		if [ $? -eq 0 ]; then
			KNOB=${CMD%%=*}
			if [ "x$VALUE" = "x" ]; then
				VALUE=${CMD##*=}
			fi

			STRIP=$(echo $KNOB | tr -d \*\?)
			if [ "x${KNOB}" != "x${STRIP}" ]; then
				do_wildcard_query "${KNOB}"
			else
				case "x${KNOB}" in
				xprompt)			
					case $VALUE in
					on)
						USE_PROMPT=1;;
					off)
						USE_PROMPT=0;;
					esac;;
				x*)
#				echo do_site_knob $KNOB $VALUE $V2 $V3 $V4 $V5
					do_site_knob $KNOB $VALUE $V2 $V3 $V4 $V5
				esac
			fi
		else
			EOF=YES
		fi
	done
else
	/usr/bin/logger -t acq400_knobs ERROR $SDIR not found
	sleep 100
	exit 1
fi
